@{
    ViewData["Title"] = "Giỏ hàng";
    var idTable = ViewData["IdTable"] ?? "";
    var restaurantId = ViewData["RestaurantId"] ?? "";
}

<head>
    <link rel="stylesheet" href="~/css/cart-detail.css" asp-append-version="true" />
</head>

<div class="cart-body d-flex flex-column justify-content-between">
    <div id="cartItemsContainer" class="cart-items mb-4">
        @* Item cart trong vùng này *@
    </div>

    <div class="cart-summary px-0" style="padding-top: 12px;">
        @if (!string.IsNullOrEmpty(idTable.ToString()) && !string.IsNullOrEmpty(restaurantId.ToString()))
        {
            <vc:promotion restaurant-id=" @restaurantId" />
        }

        <div class="cart-summary p-0 mb-2 mt-3">
            <div class="justify-content-between mb-1 mt-3" id="originalPriceRow" style="display: none;">
                <span>Giá gốc:</span>
                <span class="text-muted" id="originalPrice" style="text-decoration: line-through;">0đ</span>
            </div>
            <div class="justify-content-between mb-1" id="discountRow" style="display: none;">
                <span>Đã giảm:</span>
                <span class="text-success" id="discountAmount">0đ</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h5 class="mb-0 fw-bold">Tổng tiền:</h5>
                <h5 id="cartTotal" class="mb-0 text-danger" style="font-weight: bold; font-size: 20px;">0đ</h5>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(idTable.ToString()) && !string.IsNullOrEmpty(restaurantId.ToString()))
        {
            <vc:payment-method id-table="@idTable" restaurant-id="@restaurantId" />
        }
    </div>
</div>

@section Scripts {
    <script>
        const id_table = '@idTable';
        const restaurant_id = '@restaurantId';

        async function apiFetch(url, method = 'GET', data = null, headers = { 'Content-Type': 'application/json' }) {
            const options = { method, headers };
            if (data) options.body = JSON.stringify(data);
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            return response.json();
        }

        async function loadCartItems() {
            const cartItemsContainer = document.getElementById('cartItemsContainer');
            const checkoutBtn = document.getElementById('checkoutBtn');

            const payload = { id_table: id_table, id_restaurant: restaurant_id };
            const response = await apiFetch('https://jollicowfe-production.up.railway.app/api/admin/carts/filter', 'POST', payload);
            const cartItems = response.carts || [];

            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<div class="text-center py-4">Giỏ hàng đang trống</div>';
                if (checkoutBtn) checkoutBtn.disabled = true;
                document.getElementById('cartTotal').textContent = '0đ';
                return;
            }

            if (checkoutBtn) checkoutBtn.disabled = false;
            const cartUpdate = JSON.parse(localStorage.getItem('cart_update') || '{}');
            cartItemsContainer.innerHTML = cartItems.map((item, index) => {
                const displayQuantity = cartUpdate[item.id] ?? item.quantity;
                return `
                                                            <div class="cart-item" data-id="${item.id}" data-price="${item.price}">
                                                                <button class="btn btn-sm d-flex justify-content-center align-items-center btn-outline-danger remove-btn p-0 m-0 border-1"
                                                                        style="width: 24px; height: 24px; align-self: flex-end; border-radius: 6px" onclick="deleteItem('${item.id}')">
                                                                        <i class="bi bi-trash"></i>
                                                                </button>
                                                                <div class="cart-items-detail d-flex flex-row" style="gap: 12px">
                                                                    <div class="cart-item-image">
                                                                        <img src="${item.image}" alt="${item.name}" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover;">
                                                                    </div>
                                                                    <div class="cart-item-container">
                                                                        <div class="cart-item-details">
                                                                            <div class="cart-item-name">${item.name}</div>
                                                                            <div class="cart-item-options">
                                                                                ${item.toppings && item.toppings.length > 0 ? `Topping: ${item.toppings.join(', ')}` : ''}
                                                                            </div>
                                                                        </div>
                                                                        <div class="d-flex flex-row justify-content-between align-items-center">
                                                                            <div class="cart-item-quantity">
                                                                                <button class="quantity-btn" onclick="changeQuantity('${item.id}', -1)">-</button>
                                                                                <input id="quantity-input-${item.id}" type="number" class="quantity-input" value="${displayQuantity}" style="color: #5F6368; font-size:12px" min="1" max="99" onchange="updateQuantityInput('${item.id}')">
                                                                                <button class="quantity-btn" onclick="changeQuantity('${item.id}', 1)">+</button>
                                                                            </div>
                                                                            <div class="cart-item-price">${(item.price * displayQuantity).toLocaleString('vi-VN')}đ</div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `;
            }).join('');

            updateCartTotal(cartItems);
        }

        function changeQuantity(itemId, delta) {
            const cartUpdate = JSON.parse(localStorage.getItem('cart_update') || '{}');
            const input = document.getElementById(`quantity-input-${itemId}`);
            let current = cartUpdate[itemId] ?? Number(input.value);
            let newQuantity = Math.max(1, Math.min(99, current + delta));
            cartUpdate[itemId] = newQuantity;
            localStorage.setItem('cart_update', JSON.stringify(cartUpdate));
            input.value = newQuantity;

            // Cập nhật lại tổng tiền tạm thời
            updateCartTotalFromDOM();
        }

        async function syncCartUpdateToServer() {
            const cartUpdate = JSON.parse(localStorage.getItem('cart_update') || '{}');
            const updates = Object.entries(cartUpdate);

            if (updates.length === 0) return;

            for (const [itemId, quantity] of updates) {
                try {
                    await fetch(`https://jollicowfe-production.up.railway.app/api/admin/carts/${itemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantity: Number(quantity) })
                    });
                } catch (e) {
                    // Có thể xử lý lỗi ở đây nếu cần
                }
            }
            localStorage.removeItem('cart_update');
        }

        function deleteItem(itemId) {
            if (!confirm('Bạn có chắc chắn muốn xóa món này khỏi giỏ hàng?')) return;

            fetch('https://jollicowfe-production.up.railway.app/api/admin/carts/' + itemId, {
                method: 'DELETE'
            })
                .then(res => {
                    if (res.ok) loadCartItems();
                    else alert('Xoá thất bại!');
                });
        }

        function updateCartTotal(cartItems) {
            const total = cartItems.reduce((sum, item) => sum + ((parseFloat(item.price) || 0) * item.quantity), 0);
            const voucherData = JSON.parse(localStorage.getItem('voucher') || null);

            const cartTotalElement = document.getElementById('cartTotal');
            const originalPriceElement = document.getElementById('originalPrice');
            const originalPriceRowElement = document.getElementById('originalPriceRow');
            const discountAmountElement = document.getElementById('discountAmount');
            const discountRowElement = document.getElementById('discountRow');

            if (voucherData && voucherData.percent > 0) {
                const { percent, maxDiscount } = voucherData;
                let discounted = Math.round(total * (1 - percent / 100));
                if (total - discounted >= maxDiscount) {
                    discounted = total - maxDiscount;
                }

                cartTotalElement.textContent = discounted.toLocaleString('vi-VN') + 'đ';
                originalPriceElement.textContent = total.toLocaleString('vi-VN') + 'đ';
                discountAmountElement.textContent = (total - discounted).toLocaleString('vi-VN') + 'đ';

                originalPriceRowElement.style.display = 'flex';
                discountRowElement.style.display = 'flex';

                localStorage.setItem('cartTotalAfterDiscount', discounted);
            } else {
                cartTotalElement.textContent = total.toLocaleString('vi-VN') + 'đ';
                originalPriceRowElement.style.display = 'none';
                discountRowElement.style.display = 'none';
            }
        }

        function updateCartTotalFromDOM() {
            const cartUpdate = JSON.parse(localStorage.getItem('cart_update') || '{}');
            let total = 0;
            document.querySelectorAll('.cart-item').forEach(itemDiv => {
                const itemId = itemDiv.dataset.id;
                const price = parseFloat(itemDiv.dataset.price) || 0;
                const quantity = cartUpdate[itemId] ?? Number(itemDiv.querySelector('.quantity-input').value);
                total += price * quantity;
                // Cập nhật lại giá từng món trên UI nếu muốn:
                const priceDiv = itemDiv.querySelector('.cart-item-price');
                if (priceDiv) priceDiv.textContent = (price * quantity).toLocaleString('vi-VN') + 'đ';
            });
            document.getElementById('cartTotal').textContent = total.toLocaleString('vi-VN') + 'đ';
        }

        document.addEventListener('DOMContentLoaded', loadCartItems);

        window.addEventListener('voucherApplied', loadCartItems);

        window.addEventListener('beforeunload', syncCartUpdateToServer);

        document.getElementById('checkoutBtn')?.addEventListener('click', async function () {
            await syncCartUpdateToServer();
            // Tiếp tục chuyển sang trang thanh toán
        });

        window.addEventListener('load', () => {
            const isCheckout = sessionStorage.getItem('checkoutInProgress');
            if (!isCheckout) {
                localStorage.removeItem('voucher');
                localStorage.removeItem('cartTotalAfterDiscount');
                localStorage.removeItem('voucher_id');
            } else {
                sessionStorage.removeItem('checkoutInProgress');
            }
        });
    </script>
}
